<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Novel - Loading...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ink': '#1a1a2e',
                        'parchment': '#f5f0e8',
                        'gold': '#d4a574',
                        'crimson': '#8b2635',
                        'jade': '#2d6a4f',
                    },
                    fontFamily: {
                        'serif': ['Crimson Pro', 'Georgia', 'serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Safe area insets for notched phones */
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            overscroll-behavior: none;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: var(--sat);
            padding-left: var(--sal);
            padding-right: var(--sar);
            padding-bottom: var(--sab);
        }
        
        .chapter-row {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .chapter-row:hover {
            background: rgba(212, 165, 116, 0.1);
            border-left-color: #d4a574;
        }
        
        .chapter-row.translated {
            background: rgba(45, 106, 79, 0.05);
        }
        
        .chapter-row.translated:hover {
            background: rgba(45, 106, 79, 0.15);
            border-left-color: #2d6a4f;
        }
        
        /* Touch-friendly chapter rows on mobile */
        @media (max-width: 768px) {
            .chapter-row {
                padding: 16px 16px;
                min-height: 56px;
            }
            
            .chapter-row:active {
                background: rgba(212, 165, 116, 0.2);
            }
            
            .chapter-row.translated:active {
                background: rgba(45, 106, 79, 0.25);
            }
        }
        
        .search-container {
            background: rgba(245, 240, 232, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 165, 116, 0.3);
        }
        
        .search-input {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid rgba(212, 165, 116, 0.3);
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #d4a574;
            box-shadow: 0 0 20px rgba(212, 165, 116, 0.2);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #2d6a4f, #40916c);
        }
        
        .loading-spinner {
            border: 3px solid rgba(212, 165, 116, 0.2);
            border-top-color: #d4a574;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        
        .toc-container {
            max-height: calc(100vh - 400px);
            min-height: 300px;
        }
        
        @media (max-width: 768px) {
            .toc-container {
                max-height: calc(100vh - 350px);
                min-height: 200px;
            }
        }
        
        .badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
        }
        
        /* Custom scrollbar */
        .toc-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .toc-container::-webkit-scrollbar-track {
            background: rgba(245, 240, 232, 0.05);
            border-radius: 4px;
        }
        
        .toc-container::-webkit-scrollbar-thumb {
            background: rgba(212, 165, 116, 0.3);
            border-radius: 4px;
        }
        
        .toc-container::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 165, 116, 0.5);
        }

        .filter-btn {
            transition: all 0.2s ease;
            min-height: 44px;
        }
        
        .filter-btn.active {
            background: rgba(212, 165, 116, 0.2);
            border-color: #d4a574;
        }
        
        .filter-btn:active {
            transform: scale(0.95);
        }
        
        /* Mobile-specific layout for filters */
        @media (max-width: 768px) {
            .filter-group {
                display: flex;
                overflow-x: auto;
                gap: 8px;
                padding-bottom: 8px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .filter-group::-webkit-scrollbar {
                display: none;
            }
            
            .filter-btn {
                flex-shrink: 0;
                font-size: 0.75rem;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body class="font-serif text-parchment">
    <!-- Back Navigation -->
    <nav class="py-4 px-6">
        <a href="/" class="inline-flex items-center gap-2 text-gold hover:text-gold/80 transition-colors group">
            <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            <span class="font-semibold">Back to Library</span>
        </a>
    </nav>

    <!-- Loading State -->
    <div id="loadingState" class="flex flex-col items-center justify-center py-32">
        <div class="loading-spinner w-12 h-12 rounded-full mb-4"></div>
        <p class="text-parchment/60">Loading novel...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden max-w-md mx-auto px-6 py-20 text-center">
        <div class="text-6xl mb-4">üìö</div>
        <h2 class="text-2xl font-bold text-crimson mb-2">Unable to Load Novel</h2>
        <p class="text-parchment/60 mb-6" id="errorMessage">Could not find the requested novel.</p>
        <a href="/" class="inline-block px-6 py-3 bg-gold text-ink rounded-lg font-semibold hover:bg-gold/80 transition-colors">
            Return to Library
        </a>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="hidden max-w-4xl mx-auto px-6 pb-20">
        <!-- Novel Header -->
        <header class="mb-8">
            <h1 id="novelTitle" class="text-4xl md:text-5xl font-bold mb-6 text-gold leading-tight">
                Loading...
            </h1>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-parchment/5 rounded-xl p-4 text-center border border-parchment/10">
                    <div class="text-3xl font-bold text-gold font-mono" id="rawCount">-</div>
                    <div class="text-sm text-parchment/60">Raw Chapters</div>
                </div>
                <div class="bg-parchment/5 rounded-xl p-4 text-center border border-parchment/10">
                    <div class="text-3xl font-bold text-jade font-mono" id="translatedCount">-</div>
                    <div class="text-sm text-parchment/60">Translated</div>
                </div>
                <div class="bg-parchment/5 rounded-xl p-4 text-center border border-parchment/10">
                    <div class="text-3xl font-bold text-crimson font-mono" id="progressPercent">-</div>
                    <div class="text-sm text-parchment/60">Progress</div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="h-3 bg-parchment/10 rounded-full overflow-hidden">
                <div id="progressBar" class="progress-bar h-full rounded-full transition-all duration-700" style="width: 0%"></div>
            </div>
        </header>

        <!-- Search and Filters -->
        <section class="mb-6">
            <div class="search-container rounded-xl p-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Search Input -->
                    <div class="relative flex-1">
                        <input 
                            type="text" 
                            id="chapterSearch"
                            class="search-input w-full px-5 py-3 pl-12 rounded-lg text-parchment placeholder-parchment/40 focus:outline-none"
                            placeholder="Search by chapter number or title..."
                            autocomplete="off"
                        >
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    
                    <!-- Filter Buttons -->
                    <div class="flex gap-2 filter-group">
                        <button id="filterAll" class="filter-btn active px-4 py-2 rounded-lg border border-parchment/20 text-sm font-semibold hover:bg-parchment/10 transition-colors">
                            All
                        </button>
                        <button id="filterTranslated" class="filter-btn px-4 py-2 rounded-lg border border-parchment/20 text-sm font-semibold hover:bg-parchment/10 transition-colors flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-jade"></span>
                            Translated
                        </button>
                        <button id="filterRaw" class="filter-btn px-4 py-2 rounded-lg border border-parchment/20 text-sm font-semibold hover:bg-parchment/10 transition-colors flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-gold"></span>
                            Raw Only
                        </button>
                    </div>
                </div>
                
                <!-- Results count -->
                <div class="mt-3 text-sm text-parchment/50 font-mono">
                    Showing <span id="visibleCount" class="text-gold">0</span> of <span id="totalCount">0</span> chapters
                </div>
            </div>
        </section>

        <!-- Table of Contents -->
        <section>
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-3">
                <span>Table of Contents</span>
            </h2>
            
            <div class="toc-container overflow-y-auto rounded-xl border border-parchment/10 bg-parchment/5">
                <div id="chaptersList" class="divide-y divide-parchment/10">
                    <!-- Chapters will be inserted here -->
                </div>
                
                <!-- Empty search results -->
                <div id="noChaptersFound" class="hidden py-12 text-center">
                    <div class="text-4xl mb-3">üîç</div>
                    <p class="text-parchment/60">No chapters match your search</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // State
        let novelData = null;
        let allChapters = [];
        let fuse = null;
        let currentFilter = 'all'; // 'all', 'translated', 'raw'
        
        // Get novel ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const novelId = urlParams.get('id');
        
        // DOM Elements
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const mainContent = document.getElementById('mainContent');
        const errorMessage = document.getElementById('errorMessage');
        
        const novelTitle = document.getElementById('novelTitle');
        const rawCount = document.getElementById('rawCount');
        const translatedCount = document.getElementById('translatedCount');
        const progressPercent = document.getElementById('progressPercent');
        const progressBar = document.getElementById('progressBar');
        
        const chapterSearch = document.getElementById('chapterSearch');
        const chaptersList = document.getElementById('chaptersList');
        const noChaptersFound = document.getElementById('noChaptersFound');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');
        
        const filterAll = document.getElementById('filterAll');
        const filterTranslated = document.getElementById('filterTranslated');
        const filterRaw = document.getElementById('filterRaw');

        // Initialize Fuse.js for fuzzy search
        function initFuse(chapters) {
            fuse = new Fuse(chapters, {
                keys: [
                    { name: 'title', weight: 0.7 },
                    { name: 'chapter_number', weight: 0.3 }
                ],
                threshold: 0.4,
                distance: 100,
                includeScore: true
            });
        }

        // Show/hide states
        function showState(state) {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            mainContent.classList.add('hidden');
            
            if (state === 'loading') loadingState.classList.remove('hidden');
            else if (state === 'error') errorState.classList.remove('hidden');
            else if (state === 'content') mainContent.classList.remove('hidden');
        }

        // Create chapter row HTML
        function createChapterRow(chapter) {
            const isTranslated = chapter.is_translated;
            const chapterNum = chapter.chapter_number;
            const title = chapter.title || `Chapter ${chapterNum}`;
            
            const translatedClass = isTranslated ? 'translated' : '';
            const badge = isTranslated 
                ? '<span class="badge rounded bg-jade/20 text-jade font-mono font-bold">TRANSLATED</span>'
                : '<span class="badge rounded bg-gold/20 text-gold font-mono font-bold">RAW</span>';
            
            const href = isTranslated ? `/chapter.html?novel=${novelId}&chapter=${chapterNum}` : '#';
            const cursorClass = isTranslated ? 'cursor-pointer' : 'cursor-default opacity-60';
            const clickHandler = isTranslated ? '' : 'onclick="event.preventDefault()"';
            
            return `
                <a href="${href}" ${clickHandler} class="chapter-row ${translatedClass} ${cursorClass} block px-5 py-4 flex items-center gap-4">
                    <span class="font-mono text-lg font-bold text-parchment/40 w-16 shrink-0">
                        #${chapterNum}
                    </span>
                    <span class="flex-1 line-clamp-1 text-parchment/90">
                        ${title}
                    </span>
                    ${badge}
                </a>
            `;
        }

        // Apply filter and search
        function applyFilters() {
            const query = chapterSearch.value.trim();
            let filtered = [...allChapters];
            
            // Apply status filter
            if (currentFilter === 'translated') {
                filtered = filtered.filter(c => c.is_translated);
            } else if (currentFilter === 'raw') {
                filtered = filtered.filter(c => !c.is_translated);
            }
            
            // Apply search
            if (query && fuse) {
                const searchResults = fuse.search(query);
                const matchedNumbers = new Set(searchResults.map(r => r.item.chapter_number));
                filtered = filtered.filter(c => matchedNumbers.has(c.chapter_number));
            }
            
            renderChapters(filtered);
        }

        // Render chapters
        function renderChapters(chapters) {
            if (chapters.length === 0) {
                chaptersList.innerHTML = '';
                noChaptersFound.classList.remove('hidden');
                visibleCount.textContent = '0';
                return;
            }
            
            noChaptersFound.classList.add('hidden');
            chaptersList.innerHTML = chapters.map(createChapterRow).join('');
            visibleCount.textContent = chapters.length;
        }

        // Update filter button states
        function setActiveFilter(filter) {
            currentFilter = filter;
            
            filterAll.classList.remove('active');
            filterTranslated.classList.remove('active');
            filterRaw.classList.remove('active');
            
            if (filter === 'all') filterAll.classList.add('active');
            else if (filter === 'translated') filterTranslated.classList.add('active');
            else if (filter === 'raw') filterRaw.classList.add('active');
            
            applyFilters();
        }

        // Load novel data
        async function loadNovel() {
            if (!novelId) {
                errorMessage.textContent = 'No novel ID provided.';
                showState('error');
                return;
            }
            
            showState('loading');
            
            try {
                const response = await fetch(`/novels/${novelId}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load novel');
                }
                
                novelData = data.data;
                allChapters = novelData.table_of_contents || [];
                
                // Update page title
                document.title = `${novelData.name} - Novel Library`;
                
                // Update header
                novelTitle.textContent = novelData.name;
                rawCount.textContent = novelData.raw_chapters_count || 0;
                translatedCount.textContent = novelData.translated_chapters_count || 0;
                
                const progress = novelData.raw_chapters_count > 0 
                    ? Math.round((novelData.translated_chapters_count / novelData.raw_chapters_count) * 100) 
                    : 0;
                progressPercent.textContent = `${progress}%`;
                
                // Animate progress bar
                setTimeout(() => {
                    progressBar.style.width = `${progress}%`;
                }, 100);
                
                // Update counts
                totalCount.textContent = allChapters.length;
                
                // Initialize search
                initFuse(allChapters);
                
                // Render chapters
                renderChapters(allChapters);
                visibleCount.textContent = allChapters.length;
                
                showState('content');
                
            } catch (error) {
                console.error('Error loading novel:', error);
                errorMessage.textContent = error.message || 'Could not load the novel.';
                showState('error');
            }
        }

        // Event listeners
        chapterSearch.addEventListener('input', applyFilters);
        
        filterAll.addEventListener('click', () => setActiveFilter('all'));
        filterTranslated.addEventListener('click', () => setActiveFilter('translated'));
        filterRaw.addEventListener('click', () => setActiveFilter('raw'));
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement !== chapterSearch) {
                e.preventDefault();
                chapterSearch.focus();
            }
            if (e.key === 'Escape' && document.activeElement === chapterSearch) {
                chapterSearch.value = '';
                applyFilters();
                chapterSearch.blur();
            }
        });

        // Initialize
        loadNovel();
    </script>
</body>
</html>

